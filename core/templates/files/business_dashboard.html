{% extends 'files/baseBus.html' %}
{% load static %}

{% block title %}Dashboard{% endblock %}

{% block content %}
    <!-- End Navbar -->
    <div class="container-fluid py-4">
      <div class="row">
        <div class="col-lg-6 col-12">
          <div class="row">

            <!-- Number of Jobs Listed Card -->
            <div class="col-lg-6 col-md-6 col-12">
              <div class="card">
                <span class="mask bg-primary opacity-10 border-radius-lg"></span>
                <div class="card-body p-3 position-relative">
                  <div class="row">
                    <div class="col-8 text-start">
                      <div class="icon icon-shape bg-white shadow text-center border-radius-2xl">
                        <i class="fa fa-briefcase text-dark text-gradient text-lg opacity-10" aria-hidden="true"></i>
                      </div>
                      <h5 class="text-white font-weight-bolder mb-0 mt-3">
                        {{ jobs.count }}
                      </h5>
                      <span class="text-white text-sm">Jobs Listed</span>
                    </div>
                    <div class="col-4">
                      <div class="dropdown text-end mb-6">
                        <a href="javascript:;" class="cursor-pointer" id="dropdownUsers1" data-bs-toggle="dropdown" aria-expanded="false">
                          <i class="fa fa-ellipsis-h text-white"></i>
                        </a>
                        <ul class="dropdown-menu px-2 py-3" aria-labelledby="dropdownUsers1">
                          <li><a class="dropdown-item border-radius-md" href="{% url 'business-job-list' %}">View Jobs</a></li>
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- END OF CARD -->
            
            <!-- Number of Job Applications Card -->
            <div class="col-lg-6 col-md-6 col-12 mt-4 mt-md-0">
              <div class="card">
                <span class="mask bg-dark opacity-10 border-radius-lg"></span>
                <div class="card-body p-3 position-relative">
                  <div class="row">
                    <div class="col-8 text-start">
                      <div class="icon icon-shape bg-white shadow text-center border-radius-2xl">
                        <i class="fa fa-file text-dark text-gradient text-lg opacity-10" aria-hidden="true"></i>
                      </div>
                      <h5 class="text-white font-weight-bolder mb-0 mt-3">
                        {{ applications.count }}
                      </h5>
                      <span class="text-white text-sm">Job Applications</span>
                    </div>
                    <div class="col-4">
                      <div class="dropstart text-end mb-6">
                        <a href="javascript:;" class="cursor-pointer" id="dropdownUsers2" data-bs-toggle="dropdown" aria-expanded="false">
                          <i class="fa fa-ellipsis-h text-white"></i>
                        </a>
                        <ul class="dropdown-menu px-2 py-3" aria-labelledby="dropdownUsers2">
                          <li><a class="dropdown-item border-radius-md" href="{% url 'job_applications' %}">View Applications</a></li>
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- END OF CARD -->
            
          </div>
          <div class="row mt-4">
            <div class="col-lg-6 col-md-6 col-12">
              <div class="card">
                <span class="mask bg-dark opacity-10 border-radius-lg"></span>
                <div class="card-body p-3 position-relative">
                  <div class="row">
                    <div class="col-8 text-start">
                      <div class="icon icon-shape bg-white shadow text-center border-radius-2xl">
                        <i class="fa fa-arrow-up text-dark text-gradient text-lg opacity-10" aria-hidden="true"></i>
                      </div>
                      <h5 class="text-white font-weight-bolder mb-0 mt-3">
                        2300
                      </h5>
                      <span class="text-white text-sm">Purchases</span>
                    </div>
                    <div class="col-4">
                      <div class="dropdown text-end mb-6">
                        <a href="javascript:;" class="cursor-pointer" id="dropdownUsers3" data-bs-toggle="dropdown" aria-expanded="false">
                          <i class="fa fa-ellipsis-h text-white"></i>
                        </a>
                        <ul class="dropdown-menu px-2 py-3" aria-labelledby="dropdownUsers3">
                          <li><a class="dropdown-item border-radius-md" href="javascript:;">Action</a></li>
                          <li><a class="dropdown-item border-radius-md" href="javascript:;">Another action</a></li>
                          <li><a class="dropdown-item border-radius-md" href="javascript:;">Something else here</a></li>
                        </ul>
                      </div>
                      <p class="text-white text-sm text-end font-weight-bolder mt-auto mb-0">+15%</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-6 col-md-6 col-12 mt-4 mt-md-0">
              <div class="card">
                <span class="mask bg-dark opacity-10 border-radius-lg"></span>
                <div class="card-body p-3 position-relative">
                  <div class="row">
                    <div class="col-8 text-start">
                      <div class="icon icon-shape bg-white shadow text-center border-radius-2xl">
                        <i class="fa fa-heart text-dark text-gradient text-lg opacity-10" aria-hidden="true"></i>
                      </div>
                      <h5 class="text-white font-weight-bolder mb-0 mt-3">
                        940
                      </h5>
                      <span class="text-white text-sm">Likes</span>
                    </div>
                    <div class="col-4">
                      <div class="dropstart text-end mb-6">
                        <a href="javascript:;" class="cursor-pointer" id="dropdownUsers4" data-bs-toggle="dropdown" aria-expanded="false">
                          <i class="fa fa-ellipsis-h text-white"></i>
                        </a>
                        <ul class="dropdown-menu px-2 py-3" aria-labelledby="dropdownUsers4">
                          <li><a class="dropdown-item border-radius-md" href="javascript:;">Action</a></li>
                          <li><a class="dropdown-item border-radius-md" href="javascript:;">Another action</a></li>
                          <li><a class="dropdown-item border-radius-md" href="javascript:;">Something else here</a></li>
                        </ul>
                      </div>
                      <p class="text-white text-sm text-end font-weight-bolder mt-auto mb-0">+90%</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-6 col-12 mt-4 mt-lg-0">
          <div class="card shadow h-100">
            <div class="card-header pb-0 p-3">
              <h6 class="mb-0">Reviews</h6>
            </div>
            <div class="card-body pb-0 p-3">
              <ul class="list-group">
                <li class="list-group-item border-0 d-flex align-items-center px-0 mb-0">
                  <div class="w-100">
                    <div class="d-flex mb-2">
                      <span class="me-2 text-sm font-weight-bold text-dark">Positive Reviews</span>
                      <span class="ms-auto text-sm font-weight-bold">80%</span>
                    </div>
                    <div>
                      <div class="progress progress-md">
                        <div class="progress-bar bg-primary w-80" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100"></div>
                      </div>
                    </div>
                  </div>
                </li>
                <li class="list-group-item border-0 d-flex align-items-center px-0 mb-2">
                  <div class="w-100">
                    <div class="d-flex mb-2">
                      <span class="me-2 text-sm font-weight-bold text-dark">Neutral Reviews</span>
                      <span class="ms-auto text-sm font-weight-bold">17%</span>
                    </div>
                    <div>
                      <div class="progress progress-md">
                        <div class="progress-bar bg-primary w-10" role="progressbar" aria-valuenow="10" aria-valuemin="0" aria-valuemax="100"></div>
                      </div>
                    </div>
                  </div>
                </li>
                <li class="list-group-item border-0 d-flex align-items-center px-0 mb-2">
                  <div class="w-100">
                    <div class="d-flex mb-2">
                      <span class="me-2 text-sm font-weight-bold text-dark">Negative Reviews</span>
                      <span class="ms-auto text-sm font-weight-bold">3%</span>
                    </div>
                    <div>
                      <div class="progress progress-md">
                        <div class="progress-bar bg-primary w-5" role="progressbar" aria-valuenow="5" aria-valuemin="0" aria-valuemax="100"></div>
                      </div>
                    </div>
                  </div>
                </li>
              </ul>
            </div>
            <div class="card-footer pt-0 p-3 d-flex align-items-center">
              <div class="w-60">
                <p class="text-sm">
                  More than <b>1,500,000</b> developers used Creative Tim's products and over <b>700,000</b> projects were created.
                </p>
              </div>
              <div class="w-40 text-end">
                <a class="btn btn-dark mb-0 text-end" href="javascript:;">View all reviews</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
<!-- Rounded Orange Badge Button -->
<!-- Rounded Orange Badge Button -->
<button class="position-fixed bottom-3 end-3 btn btn-warning rounded-circle shadow-lg d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;" data-bs-toggle="modal" data-bs-target="#customModal">
  <i class="fa fa-plus text-white" style="font-size: 1.5rem;"></i>
</button>


<!-- Modal -->
<div class="modal fade" id="customModal" tabindex="-1" aria-labelledby="customModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="customModalLabel">Create A Job Listing - Step <span id="currentStep">1</span>/3</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Form wrapper -->
        <form id="jobForm" method="POST">
          {% csrf_token %}
          <input type="hidden" name="form_type" value="job">
          <input type="hidden" name="current_step" id="stepInput" value="1">
          
                    <!-- Step 1 Content --><!-- Step 1 Content -->
          <div id="step1Content" class="step-content">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="job_title" class="form-label">Job Title*</label>
                    <input type="text" id="job_title" name="job_title" class="form-control" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="department" class="form-label">Department*</label>
                    <input type="text" id="department" name="department" class="form-control" required>
                </div>
            </div>

            <div class="mb-3">
                <label for="job_description" class="form-label">Job Description*</label>
                <textarea id="job_description" name="job_description" class="form-control" rows="4" required></textarea>
            </div>

            <div class="mb-3">
                <label for="required_qualifications" class="form-label">Required Qualifications*</label>
                <textarea id="required_qualifications" name="required_qualifications" class="form-control" rows="4" required></textarea>
            </div>

            <div class="row">
              <div class="col-md-4 mb-3">
                  <label for="employment_type" class="form-label">Employment Type*</label>
                  <select id="employment_type" name="employment_type" class="form-select" required>
                      <option value="">Select Type</option>
                      {% for value, label in employment_types %}
                          <option value="{{ value }}">{{ label }}</option>
                      {% endfor %}
                  </select>
              </div>
              <div class="col-md-4 mb-3">
                  <label for="job_category" class="form-label">Job Category*</label>
                  <div class="input-group">
                      <select id="job_category_select" class="form-select" onchange="handleCategoryChange(this)">
                          <option value="">Select Category</option>
                          {% for value, label in job_categories %}
                              <option value="{{ value }}">{{ label }}</option>
                          {% endfor %}
                          <option value="custom">Other (Type Custom)</option>
                      </select>
                      <input type="text" id="job_category" name="job_category" class="form-control d-none" 
                             placeholder="Enter custom category" required>
                  </div>
              </div>
              <div class="col-md-4 mb-3">
                  <label for="pay_grade" class="form-label">Pay Grade*</label>
                  <select id="pay_grade" name="pay_grade" class="form-select" required>
                      <option value="">Select Grade</option>
                      {% for value, label in pay_grades %}
                          <option value="{{ value }}">{{ label }}</option>
                      {% endfor %}
                  </select>
              </div>
          </div>
          
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="minimum_pay" class="form-label">Minimum Pay (Annual)*</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" id="minimum_pay" name="minimum_pay" class="form-control" 
                              placeholder="e.g., 50000" required min="0" step="1000">
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="maximum_pay" class="form-label">Maximum Pay (Annual)*</label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="number" id="maximum_pay" name="maximum_pay" class="form-control" 
                              placeholder="e.g., 70000" required min="0" step="1000">
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="location_type" class="form-label">Location Type*</label>
                    <select id="location_type" name="location_type" class="form-select" required>
                        <option value="">Select Type</option>
                        {% for value, label in location_types %}
                            <option value="{{ value }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="mb-3">
                <label for="work_location" class="form-label">Work Location*</label>
                <input type="text" id="work_location" name="work_location" class="form-control" 
                      placeholder="City, Country or Remote" required>
            </div>

            <div class="mb-3">
                <label for="skills_required" class="form-label">Required Skills*</label>
                <textarea id="skills_required" name="skills_required" class="form-control" rows="3" 
                          placeholder="List key skills required for this position" required></textarea>
            </div>

            <div class="mb-3">
                <label for="benefits" class="form-label">Benefits, Perks $ Remarks</label>
                <textarea id="benefits" name="benefits" class="form-control" rows="3" 
                          placeholder="List job benefits and perks"></textarea>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="application_deadline" class="form-label">Application Deadline*</label>
                    <input type="date" id="application_deadline" name="application_deadline" class="form-control" required>
                </div>
                <div class="col-md-6 mb-3" hidden>
                    <label class="d-block form-label" for="status">Status</label>
                    <div class="form-check form-switch" id="status" name="status">
                        <input type="checkbox" id="is_active" name="is_active" class="form-check-input" checked>
                        <label for="is_active" class="form-check-label">Active</label>
                    </div>
                </div>
            </div>
          </div>

          <!-- Step 2 Content -->
          <div id="step2Content" class="step-content d-none">
            <div class="alert alert-info mb-4">
                <div class="d-flex">
                    <i class="fa fa-info-circle me-2 mt-1"></i>
                    <div>
                        <h6 class="mb-1">Custom Application Questions</h6>
                        <p class="mb-0">Add screening questions for candidates. You can create different types of questions including text answers, multiple choice, yes/no, or file upload requirements.</p>
                    </div>
                </div>
            </div>

            <div id="questions-container">
                <!-- Questions will be added here dynamically -->
            </div>

            <div class="text-center mt-4">
                <button type="button" class="btn btn-primary" onclick="addQuestion()">
                    <i class="fa fa-plus-circle me-2"></i>Add New Question
                </button>
            </div>
          </div>

          <!-- Step 3 Content -->
          <!-- Step 3 Content -->
          <div id="step3Content" class="step-content d-none">
            <div class="mb-3">
                <label for="collegeSelection" class="form-label">Select Target Colleges*</label>
                <div id="collegeSelection" name="collegeSelection" class="border p-3" style="max-height: 300px; overflow-y: auto;">
                    
                    <h6 class="mb-2">Suggested Colleges:</h6>
                    <div id="suggestedColleges">
                        <!-- Suggested colleges will be added here -->
                    </div>
                    <hr>

                    <h6 class="mb-2">All Colleges:</h6>
          <!-- Modified college listing section -->
          {% for college in colleges %}
              <div class="form-check d-flex justify-content-between align-items-center">
                  <div>
                      <input class="form-check-input" type="checkbox" 
                            name="selected_colleges" value="{{ college.id }}" 
                            id="college{{ college.id }}">
                      <label class="form-check-label" for="college{{ college.id }}">
                          {{ college.name }}
                      </label>
                  </div>
              </div>
              {% for cpc_job_filter in cpc_job_filters %}
                  {% if cpc_job_filter.cpc_profile.college == college %}
                      <div id="filter{{ college.id }}" class="mt-2 cpc-filter-info d-none" 
                          data-minimum-salary="{{ cpc_job_filter.minimum_salary }}"
                          data-allowed-employment-types="{{ cpc_job_filter.allowed_employment_types|join:',' }}"
                          data-allowed-job-categories="{{ cpc_job_filter.allowed_job_categories|join:',' }}"
                          data-custom-job-categories="{{ cpc_job_filter.custom_job_categories|join:',' }}">
                          <h6 class="mb-1">CPC Job Filter:</h6>
                          {% if cpc_job_filter.minimum_salary %}
                              <p><i class="fa fa-money me-1"></i> Minimum Salary: ${{ cpc_job_filter.minimum_salary }}</p>
                          {% endif %}
                          {% if cpc_job_filter.allowed_employment_types %}
                              <p><i class="fa fa-clock-o me-1"></i> Allowed Employment Types: {{ cpc_job_filter.allowed_employment_types|join:", " }}</p>
                          {% endif %}
                          {% if cpc_job_filter.allowed_job_categories %}
                              <p><i class="fa fa-folder-open-o me-1"></i> Allowed Job Categories: {{ cpc_job_filter.allowed_job_categories|join:", " }}</p>
                          {% endif %}
                          {% if cpc_job_filter.custom_job_categories %}
                              <p><i class="fa fa-tags me-1"></i> Custom Job Categories: {{ cpc_job_filter.custom_job_categories|join:", " }}</p>
                          {% endif %}
                      </div>
                  {% endif %}
              {% endfor %}
          {% endfor %}
                </div>
            </div>
          </div>

          <!-- Navigation Buttons -->
          <div class="d-flex justify-content-between mt-4">
            <button type="button" class="btn btn-secondary" id="prevBtn" onclick="prevStep()" style="display: none;">
              Previous
            </button>
            <button type="button" class="btn btn-primary" id="nextBtn" onclick="nextStep()">
              Next
            </button>
            <button type="submit" class="btn btn-success" id="submitBtn" style="display: none;">
              Post Job
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>


<!-- Profile Creation Modal -->
{% if not profile_complete %}
<div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="profileModalLabel">Complete Your Business Profile</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form method="POST">
          {% csrf_token %}

          <input type="hidden" name="form_type" value="profile"> <!-- Hidden Field to Identify Form Type -->
          <div class="mb-3">
            <label class="form-label">Business Name</label>
            <input type="text" class="form-control" name="business_name" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Industry</label>
            <select class="form-control" name="industry" required>
              <option value="">Click to Select</option>
              <option value="tech">Technology</option>
              <option value="finance">Finance</option>
              <option value="health">Healthcare</option>
              <option value="education">Education</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Location</label>
            <input type="text" class="form-control" name="location" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Phone Number</label>
            <input type="text" class="form-control" name="phone_number" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Website</label>
            <input type="url" class="form-control" name="website">
          </div>
          <div class="mb-3">
            <label class="form-label">Briefly Describe the business</label>
            <textarea class="form-control" name="description" rows="3"></textarea>
          </div>
          <button type="submit" class="btn btn-primary">Save Profile</button>
        </form>
      </div>
    </div>
  </div>
</div>

{% endif %} 


<script>
  function toggleFilter(filterId) {
      const filterDiv = document.getElementById(filterId);
      filterDiv.classList.toggle('d-none');
  }
</script>

<style>
  .cpc-filter-info {
      border: 1px solid #ddd;
      padding: 10px;
      margin-top: 5px;
      border-radius: 5px;
  }
</style>


<script>
  function prevStep() {
    if (currentStep > 1) {
        currentStep--;
        showStep(currentStep);
        
        // Clear suggested colleges if going back from step 3 to step 2
        if (currentStep === 2) {
            const suggestedCollegesDiv = document.getElementById('suggestedColleges');
            if (suggestedCollegesDiv) {
                suggestedCollegesDiv.innerHTML = '';
            }
        }
    }
}

document.getElementById('nextBtn').addEventListener('click', function() {
    if (currentStep === 1) {
        suggestColleges();
    }
    nextStep();
});

function suggestColleges() {
    // Get job details from Step 1
    const employmentType = document.getElementById('employment_type').value.trim().toLowerCase();
    const jobCategorySelect = document.getElementById('job_category_select');
    const jobCategory = jobCategorySelect.value === 'custom' 
        ? document.getElementById('job_category').value.trim().toLowerCase()
        : jobCategorySelect.value.trim().toLowerCase();
    const minimumPay = parseFloat(document.getElementById('minimum_pay').value);

    console.log("Job Details:", {
        employmentType,
        jobCategory,
        minimumPay
    });

    // Get all colleges containers
    const suggestedCollegesDiv = document.getElementById('suggestedColleges');
    const allCollegesSection = document.querySelector('#collegeSelection h6:last-of-type');
    
    // Clear previous suggestions
    suggestedCollegesDiv.innerHTML = '';
    
    // Get all college elements before removing them
    const collegeElements = Array.from(document.querySelectorAll('.form-check'));
    
    // Arrays to store sorted colleges
    const suggestedColleges = [];
    const remainingColleges = [];

    // Process each college
    collegeElements.forEach((collegeDiv, index) => {
        // Remove the college from current position
        collegeDiv.remove();
        
        const checkbox = collegeDiv.querySelector('input[name="selected_colleges"]');
        if (!checkbox) return;

        const collegeId = checkbox.value;
        const filterDiv = document.getElementById(`filter${collegeId}`);
        
        console.log(`Processing college ${collegeId}:`, {
            hasFilter: !!filterDiv,
            filterData: filterDiv ? {
                minimumSalary: filterDiv.dataset.minimumSalary,
                employmentTypes: filterDiv.dataset.allowedEmploymentTypes,
                jobCategories: filterDiv.dataset.allowedJobCategories,
                customCategories: filterDiv.dataset.customJobCategories
            } : null
        });

        if (filterDiv) {
            const minimumSalary = parseFloat(filterDiv.dataset.minimumSalary) || 0;
            const allowedEmploymentTypes = (filterDiv.dataset.allowedEmploymentTypes || '').split(',').map(t => t.trim().toLowerCase());
            const allowedJobCategories = (filterDiv.dataset.allowedJobCategories || '').split(',').map(c => c.trim().toLowerCase());
            const customJobCategories = (filterDiv.dataset.customJobCategories || '').split(',').map(c => c.trim().toLowerCase());

            // Check matches
            const minimumPayMatch = minimumPay >= minimumSalary;
            const employmentTypeMatch = !allowedEmploymentTypes.length || allowedEmploymentTypes.includes(employmentType);
            const jobCategoryMatch = (!allowedJobCategories.length && !customJobCategories.length) || 
                                   allowedJobCategories.includes(jobCategory) || 
                                   customJobCategories.includes(jobCategory);

            console.log(`College ${collegeId} match results:`, {
                minimumPayMatch,
                employmentTypeMatch,
                jobCategoryMatch
            });

            if (minimumPayMatch && employmentTypeMatch && jobCategoryMatch) {
                suggestedColleges.push(collegeDiv.cloneNode(true));
            } else {
                remainingColleges.push(collegeDiv.cloneNode(true));
            }
        } else {
            remainingColleges.push(collegeDiv.cloneNode(true));
        }
    });

    // Add suggested colleges
    if (suggestedColleges.length > 0) {
        suggestedColleges.forEach(college => {
            suggestedCollegesDiv.appendChild(college);
        });
    } else {
        suggestedCollegesDiv.innerHTML = '<p class="text-muted">No colleges match your job criteria</p>';
    }

    // Add remaining colleges
    remainingColleges.forEach(college => {
        allCollegesSection.insertAdjacentElement('afterend', college);
    });

    // Sync checkboxes
    document.querySelectorAll('input[name="selected_colleges"]').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const collegeId = this.value;
            const relatedCheckboxes = document.querySelectorAll(`input[value="${collegeId}"]`);
            relatedCheckboxes.forEach(cb => {
                if (cb !== this) cb.checked = this.checked;
            });
        });
    });
}
  // Global variables
  let currentStep = 1;
  let questionCount = 0;
  
// Add this to your existing script section
function handleCategoryChange(selectElement) {
    const customInput = document.getElementById('job_category');
    if (selectElement.value === 'custom') {
        selectElement.classList.add('d-none');
        customInput.classList.remove('d-none');
        customInput.focus();
    } else {
        customInput.value = selectElement.value;
    }
}


// Update the validateStep function to include minimum/maximum pay validation
function validateStep(step) {
    if (step === 1) {
        const requiredFields = [
            'job_title', 'department', 'job_description', 
            'required_qualifications', 'employment_type', 
            'job_category', 'pay_grade', 'minimum_pay', 'maximum_pay',
            'location_type', 'work_location', 'skills_required',
            'application_deadline'
        ];

        for (const field of requiredFields) {
            const element = document.querySelector(`[name="${field}"]`);
            if (!element || !element.value.trim()) {
                alert(`Please fill in the ${field.replace('_', ' ')}`);
                element.focus();
                return false;
            }
        }

        // Validate pay range
        const minPay = parseFloat(document.getElementById('minimum_pay').value);
        const maxPay = parseFloat(document.getElementById('maximum_pay').value);
        if (maxPay <= minPay) {
            alert('Maximum pay must be greater than minimum pay');
            document.getElementById('maximum_pay').focus();
            return false;
        }

        return true;
    }
    return true;
}
  // Form handling functions
  function showStep(step) {
      step = parseInt(step);
      currentStep = step;
  
      document.querySelectorAll('.step-content').forEach(content => {
          content.classList.add('d-none');
      });
  
      document.getElementById(`step${step}Content`).classList.remove('d-none');
      document.getElementById('currentStep').textContent = step;
      document.getElementById('stepInput').value = step;
  
      // Update navigation buttons
      document.getElementById('prevBtn').style.display = step === 1 ? 'none' : 'block';
      document.getElementById('nextBtn').style.display = step === 3 ? 'none' : 'block';
      document.getElementById('submitBtn').style.display = step === 3 ? 'block' : 'none';
  }
  
  async function nextStep() {
    if (validateStep(currentStep)) {
        const formData = new FormData(document.getElementById('jobForm'));
        formData.append('form_type', 'job');
        formData.append('current_step', currentStep.toString());
        
        // If on step 2, collect and add questions data
        if (currentStep === 2) {
            const questionsData = [];
            const cards = document.querySelectorAll('.card');
            console.log(`Found ${cards.length} question cards`);
            
            cards.forEach((card, index) => {
                const questionText = card.querySelector('textarea[name^="question_text_"]');
                const questionType = card.querySelector('select[name^="question_type_"]');
                const isRequired = card.querySelector('input[name^="is_required_"]');
                const options = card.querySelector('input[name^="options_"]');

                console.log(`Processing question ${index + 1}:`, {
                    text: questionText?.value,
                    type: questionType?.value,
                    required: isRequired?.checked,
                    options: options?.value
                });

                if (questionText?.value && questionType?.value) {
                    questionsData.push({
                        question_text: questionText.value,
                        question_type: questionType.value,
                        is_required: isRequired?.checked || false,
                        options: options?.value || '',
                        order: index
                    });
                }
            });

            console.log('Questions data being sent:', questionsData);
            formData.append('questions_data', JSON.stringify(questionsData));
            formData.append('question_count', questionsData.length.toString());
        }

        try {
            console.log('Sending form data...');
            const response = await fetch(window.location.href, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                credentials: 'same-origin'
            });

            const data = await response.json();
            console.log('Server response:', data);

            if (data.status === 'success') {
                showStep(parseInt(data.step));
            } else {
                alert(data.message || 'An error occurred');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while processing your request');
        }
    }
}

// Update addQuestion function to include proper name attributes and event handlers
function addQuestion() {
    const container = document.getElementById('questions-container');
    const questionDiv = document.createElement('div');
    questionDiv.className = 'card mb-3 border';
    questionDiv.innerHTML = `
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="card-title mb-0">Question ${questionCount + 1}</h6>
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeQuestion(this)">
                    <i class="fa fa-trash"></i>
                </button>
            </div>
            <div class="mb-3">
                <label class="form-label">Question Text*</label>
                <textarea name="question_text_${questionCount}" 
                          class="form-control" 
                          required 
                          rows="2"
                          placeholder="Enter your question here..."></textarea>
            </div>
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Question Type*</label>
                    <select name="question_type_${questionCount}" 
                            class="form-select question-type" 
                            onchange="toggleOptions(this)" 
                            required>
                        <option value="">Select question type</option>
                        <option value="text">Text Answer</option>
                        <option value="multiple_choice">Multiple Choice</option>
                        <option value="yes_no">Yes/No</option>
                        <option value="file_upload">File Upload</option>
                    </select>
                </div>
                <div class="col-md-6 d-flex align-items-center">
                    <div class="form-check form-switch">
                        <input class="form-check-input" 
                               type="checkbox" 
                               name="is_required_${questionCount}" 
                               checked>
                        <label class="form-check-label">Required Question</label>
                    </div>
                </div>
            </div>
            <div class="options-container mt-3" style="display: none;">
                <label class="form-label">Answer Options*</label>
                <div class="input-group">
                    <input type="text" 
                           name="options_${questionCount}" 
                           class="form-control" 
                           placeholder="Enter options separated by commas">
                    <button class="btn btn-outline-secondary" 
                            type="button" 
                            onclick="previewOptions(this)">
                        <i class="fa fa-eye"></i>
                    </button>
                </div>
                <div class="options-preview mt-2 small text-muted"></div>
            </div>
        </div>
    `;
    container.appendChild(questionDiv);
    questionCount++;
}
  
  function removeQuestion(button) {
      button.closest('.card').remove();
  }
  
  function toggleOptions(select) {
      const optionsContainer = select.closest('.card-body').querySelector('.options-container');
      optionsContainer.style.display = select.value === 'multiple_choice' ? 'block' : 'none';
  }
  
  function previewOptions(button) {
      const optionsInput = button.closest('.input-group').querySelector('input');
      const previewDiv = button.closest('.options-container').querySelector('.options-preview');
      const options = optionsInput.value.split(',').map(opt => opt.trim()).filter(opt => opt);
  
      previewDiv.innerHTML = options.length > 0 
          ? '<strong>Preview:</strong><br>' + options.map((opt, i) => 
              `<div class="form-check mt-1">
                  <input class="form-check-input" type="radio" name="preview_${questionCount}" disabled>
                  <label class="form-check-label">${opt}</label>
              </div>`
          ).join('')
          : '<span class="text-danger">No options added yet</span>';
  }
  
  // Form submission handler with validation
  document.getElementById('jobForm').addEventListener('submit', async function(e) {
      e.preventDefault();
  
      if (!validateStep(currentStep)) {
          return;
      }
  
      const formData = new FormData(this);
      formData.append('form_type', 'job');
      formData.append('current_step', currentStep.toString());
  
      // If on step 2, add questions data
      if (currentStep === 2) {
          const questionsData = [];
          document.querySelectorAll('.card').forEach((card, index) => {
              const questionText = card.querySelector(`[name="question_text_${index}"]`);
              const questionType = card.querySelector(`[name="question_type_${index}"]`);
              const isRequired = card.querySelector(`[name="is_required_${index}"]`);
              const options = card.querySelector(`[name="options_${index}"]`);
  
              if (questionText && questionType && isRequired) {
                  questionsData.push({
                      question_text: questionText.value,
                      question_type: questionType.value,
                      is_required: isRequired.checked,
                      options: options ? options.value : ''
                  });
              }
          });
          formData.append('questions_data', JSON.stringify(questionsData));
      }
  
      // Log form data before submission
      console.log('Submitting form data:');
      for (let pair of formData.entries()) {
          console.log(pair[0] + ': ' + pair[1]);
      }
  
      try {
          const response = await fetch(window.location.href, {
              method: 'POST',
              body: formData,
              headers: {
                  'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
              },
              credentials: 'same-origin'
          });
  
          const data = await response.json();
          console.log('Response:', data);
  
          if (data.status === 'success') {
              if (data.redirect) {
                  window.location.href = data.redirect;
              } else {
                  showStep(parseInt(data.step));
              }
          } else {
              alert(data.message || 'An error occurred');
          }
      } catch (error) {
          console.error('Error:', error);
          alert('An error occurred while processing your request');
      }
  });
  
  // Modal event handlers
  document.getElementById('customModal').addEventListener('hidden.bs.modal', function () {
      currentStep = 1;
      showStep(1);
      document.getElementById('questions-container').innerHTML = '';
      questionCount = 0;
      document.getElementById('jobForm').reset();
  });
  
  // Initialize on page load
  document.addEventListener('DOMContentLoaded', function() {
      const profileComplete = {{ profile_complete|yesno:"true,false" }};
      if (!profileComplete) {
          const myModal = new bootstrap.Modal(document.getElementById('profileModal'));
          myModal.show();
      }
      showStep(1);
  });
  </script>

{% endblock %}
